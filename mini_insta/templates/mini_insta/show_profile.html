{% extends 'mini_insta/base.html' %}

{% block content %}
<main class="grid profile-header">

{% if request.user.is_authenticated and profile.user_id != request.user.id %}
  <form action="{% url 'mini_insta:follow' profile.pk %}" method="post" style="display:inline">
    {% csrf_token %}
    {% if is_following %}
      <button formaction="{% url 'mini_insta:delete_follow' profile.pk %}" type="submit">Unfollow</button>
    {% else %}
      <button type="submit">Follow</button>
    {% endif %}
  </form>
{% endif %}
  <!-- Profile image -->
  <div class="profile-image">
    {% if profile.profile_image_url %}
      <img src="{{ profile.profile_image_url }}" alt="{{ profile.display_name }}">
    {% else %}
      <img src="https://via.placeholder.com/200" alt="No image">
    {% endif %}
  </div>

  <!-- Profile info -->
  <div class="profile-info">
    <div class="profile-header-item">
      <h2>{{ profile.display_name }}</h2>
      <h3>@{{ profile.username }}</h3>
    </div>

    <div class="profile-header-item">
      <strong>
        <a href="{% url 'mini_insta:show_followers' profile.pk %}">
          {{ profile.get_num_followers }}
        </a> Followers Â·
        <a href="{% url 'mini_insta:show_following' profile.pk %}">
          {{ profile.get_num_following }}
        </a> Following
      </strong>
    </div>

    <div class="profile-header-item">
      <p>{{ profile.bio_text }}</p>
    </div>

    <div class="profile-header-item">
      <small>Joined: {{ profile.join_date }}</small>
    </div>

    <!-- Owner-only actions -->
    {% if request.user.is_authenticated and profile.user_id == request.user.id %}
      <div class="profile-header-item" style="margin-top: .75rem;">
        <a href="{% url 'mini_insta:update_profile' %}" class="button">Update Profile</a>
        <a href="{% url 'mini_insta:create_post' %}" class="button">+ Create Post</a>
        <a href="{% url 'mini_insta:show_feed' %}" class="button">Home / Feed</a>
      </div>
    {% endif %}

    <!-- Search: any logged-in user -->
    {% if request.user.is_authenticated %}
      <div class="profile-header-item" style="margin-top: .5rem;">
        <a href="{% url 'mini_insta:search' %}">Search</a>
      </div>
    {% endif %}
  </div>

  <!-- Posts grid -->
  <div>
    <h2>Posts</h2>
    {% for post in profile.get_all_posts %}
      <a href="{% url 'mini_insta:show_post' post.pk %}">
        {% with photo=post.get_all_photos.0 %}
          {% if photo and photo.get_image_url %}
            <img src="{{ photo.get_image_url }}" alt="{{ post.caption }}">
          {% elif post.get_image_url %}
            <img src="{{ post.get_image_url }}" alt="{{ post.caption }}">
          {% else %}
            <img src="https://via.placeholder.com/200" alt="No image">
          {% endif %}
        {% endwith %}
      </a>
    {% empty %}
      <p>No posts yet.</p>
    {% endfor %}
  </div>

</main>
{% endblock %}
